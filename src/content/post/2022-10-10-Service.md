---
layout: post
title: ì„œë¹„ìŠ¤ ì¶”ìƒí™”
author: [4ê¸°_ì—°ë¡œê·¸]
tags: ['service', 'test']
date: '2022-10-10T12:00:00.000Z'
draft: false
image: ../teaser/abstract-art.jpg
---

# ğŸ˜˜ ì„œë¡ 

ìš°ì•„í•œí…Œí¬ì½”ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” í˜‘ì—… ë„êµ¬ ì¤‘ í•˜ë‚˜ì¸ `Slack`ì€ ë¬´ë£Œ í”„ë¦¬í‹°ì–´ ì‚¬ìš© ì‹œ 3ê°œì›”ì´ ì§€ë‚œ ë©”ì‹œì§€ë“¤ì„ ë³´ì—¬ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
ë ˆë²¨ 3 íŒ€ í”„ë¡œì íŠ¸ì¸ [ì¤ì¤](https://github.com/woowacourse-teams/2022-pickpick)ì—ì„œëŠ” ì´ ì‚¬ë¼ì§€ëŠ” ë©”ì‹œì§€ë“¤ì„ ë°±ì—…í•´ì£¼ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
`Slack`ì˜ ë©”ì‹œì§€ì— ëŒ€í•œ ì •ë³´ë¥¼ ì£¼ë¡œ ë‹¤ë£¨ë‹¤ ë³´ë‹ˆ `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ì— ì˜ì¡´ì ì¸ ë¡œì§ì´ ë§ìŠµë‹ˆë‹¤.
ì´ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬(`Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`)ë¥¼ ì‚¬ìš©í•˜ëŠ” **ë¡œì§ì„ ì–´ë–»ê²Œ, ì™œ ì¶”ìƒí™”í–ˆëŠ”ì§€**ì— ê´€í•´ ì´ì•¼ê¸°í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

<br/><br/>

# ğŸ¤” ì™œ ì„œë¹„ìŠ¤ë¥¼ ì¶”ìƒí™”í•´ì•¼ í•˜ëŠ”ê°€?

<img src="../images/2022-10-10-slack.png" width="30%"/>

ê¸°ì¡´ì˜ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì€ ëª¨í‚¹ ì²˜ë¦¬í•´ë‘ì—ˆìŠµë‹ˆë‹¤.
í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§í•˜ë‹¤ ë³´ë‹ˆ ëª¨í‚¹ ì‘ì—…ì´ ê³„ì† **ë°˜ë³µ**ë˜ëŠ” **ì§€ë£¨**í•œ ì‘ì—…ìœ¼ë¡œ ëŠê»´ì¡ŒìŠµë‹ˆë‹¤.
ë°˜ë³µë˜ëŠ” ëª¨í‚¹ ì‘ì—…ì„ ì œê±°í•˜ê¸° ìœ„í•´ í…ŒìŠ¤íŠ¸ ë°©ì‹ì„ `ëª©`ì—ì„œ `ìŠ¤í…`ìœ¼ë¡œ ë³€ê²½í•´ì•¼ê² ë‹¤ëŠ” ê²°ì‹¬ì„ í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
(í…ŒìŠ¤íŠ¸ì— ëŒ€í•œ ì´ì•¼ê¸°ëŠ” `2ê¸°_ìŠ¤í‹°ì¹˜`ì˜ [Test Doubleì„ ì•Œì•„ë³´ì](https://tecoble.techcourse.co.kr/post/2020-09-19-what-is-test-double/)ë¥¼ ì°¸ê³ 
ë°”ëë‹ˆë‹¤.)

`Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ì˜ ìŠ¤í…ìš© ê°ì²´ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” `MethodsClient`ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ëŠ” ì•½ 250ê°œì˜ ë©”ì„œë“œë¥¼ ê°–ê³  ìˆìœ¼ë©° ê·¸ì¤‘ ì €í¬ ì„œë¹„ìŠ¤ì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ë©”ì„œë“œëŠ” ì•½ 10ê°œ ì •ë„ì— ë¶ˆê³¼í•©ë‹ˆë‹¤.
ì´ë¥¼ ëª¨ë‘ êµ¬í˜„í•˜ëŠ” ê²ƒì€ ë¶ˆí•„ìš”í•˜ê³  ë²ˆê±°ë¡œìš´ ì‘ì—…ì´ê¸°ì— ë” ê°„í¸í•œ ë°©ë²•ì„ ê³ ë¯¼í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.
ì´ë•Œ ë– ì˜¤ë¥¸ ë°©ë²•ì´ **ì„œë¹„ìŠ¤ë¥¼ ì¶”ìƒí™”í•´ í•„ìš”í•œ ë¶€ë¶„ë§Œ** ì‚¬ìš©í•˜ë„ë¡ ë§Œë“œëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.
ìì„¸í•œ ì„¤ëª…ì€ ì•„ë˜ ì˜ˆì œ ì½”ë“œë¥¼ ë³´ë©° ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

<br/><br/>

# ğŸ˜† ì˜ˆì œ ì½”ë“œ

## 0. ê¸°ì¡´ ì½”ë“œ

ì˜ˆì œë¡œ ì±„ë„ì„ ìƒì„±í•˜ëŠ” `ChannelCreateService`ì˜ ê¸°ì¡´ ë¡œì§ì„ ê°€ì ¸ì™€ ë³´ì•˜ìŠµë‹ˆë‹¤.
ë¡œì§ ëŒ€ë¶€ë¶„ì´ `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ì— ì˜ì¡´í•˜ê³  ìˆìŠµë‹ˆë‹¤.

```java

@Transactional
@Service
public class ChannelCreatedService {

  private MethodsClient slackClient;
  private ChannelRepository channels;

  public ChannelCreatedService(final MethodsClient slackClient, final ChannelRepository channels) {
    this.slackClient = slackClient;
    this.channels = channels;
  }

  public Channel execute(final String channelSlackId) {
    try {
      // slack apië¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„
      Conversation conversation = slackClient
        .conversationsInfo(request -> request.channel(channelSlackId))
        .getChannel();

      // slackì˜ responseë¥¼ ìš°ë¦¬ ë„ë©”ì¸ì¸ channel í˜•íƒœë¡œ ë³€í™˜
      Channel channel = toChannel(conversation);

      // channelì„ ì €ì¥í•˜ê³  return
      return channels.save(channel);

    } catch (IOException | SlackApiException e) { // slack api í˜¸ì¶œë¡œ ì¸í•´ ë°œìƒí•  ìˆ˜ ìˆëŠ” exception
      throw new SlackApiCallException();
    }
  }
}
```

![](../images/2022-10-10-service-ver1.png)

<br/>

## 1. ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì“°ëŠ” ë¡œì§ ì¶”ìƒí™”

ìœ„ ë¡œì§ì„ ì•„ë˜ì²˜ëŸ¼ ë‘ ê°œì˜ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•˜ì—¬ ì—­í• ì„ ë‚˜ëˆ ì£¼ì—ˆìŠµë‹ˆë‹¤.

#### ChannelCreateService
- ì±„ë„ ì €ì¥ ë¡œì§ì„ ê°€ì§„ í´ë˜ìŠ¤

```java

@Transactional
@Service
public class ChannelCreatedService {

  private CallSlackApi slackClient;
  private ChannelRepository channels;

  public ChannelCreatedService(final CallSlackApi slackClient, final ChannelRepository channels) {
    this.slackClient = slackClient;
    this.channels = channels;
  }

  public Channel execute(final String channelSlackId) {
    Channel channel = slackClient.callChannel(channelSlackId);
    return channels.save(channel);
  }
}
```

#### CallSlackApi
- `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ë¥¼ í˜¸ì¶œí•˜ê³  ê²°ê´ê°’ì„ ë°˜í™˜í•˜ëŠ” í´ë˜ìŠ¤

```java

@Component
public class CallSlackApi {

  private final MethodsClient methodsClient;

  public CallSlackApi(final MethodsClient methodsClient) {
    this.methodsClient = methodsClient;
  }

  public Channel callChannel(final String channelSlackId) {
    try {
      // `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ë¥¼ í˜¸ì¶œ
      Conversation conversation = methodsClient.conversationsInfo(
          request -> request.channel(channelSlackId))
        .getChannel();

      // ê²°ê³¼ê°’ì„ ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ê°ì²´ í˜•íƒœë¡œ ë³€ê²½
      return new Channel(conversation.getId(), conversation.getName());

    } catch (IOException | SlackApiException e) {
      throw new SlackApiCallException();
    }
  }
}
```

![](../images/2022-10-10-service-ver2.png)

<br/>

## 2. ì¶”ìƒí™”í•œ ë¡œì§ ì¸í„°í˜ì´ìŠ¤ë¡œ ë¶„ë¦¬

ì¢€ ë” í¸ë¦¬í•œ ìŠ¤í… ê°ì²´ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ `ExternalClient`ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
ê¸°ì¡´ì˜ `CallSlackApi`ì— ì¡´ì¬í•˜ë˜ ë¡œì§ì€ `ExternalClient` ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ì¸ `SlackClient`ë¡œ ì˜®ê²¼ìŠµë‹ˆë‹¤.

#### ExternalClient
- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë¡œì§ì„ ì¶”ìƒí™”í•œ ì¸í„°í˜ì´ìŠ¤

```java
public interface ExternalClient {
  Channel callChannel(String channelSlackId);
}
```

#### SlackClient
- `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ë¥¼ í˜¸ì¶œí•˜ëŠ” `ExternalClient`ì˜ êµ¬í˜„ì²´

```java

@Component
public class SlackClient implements ExternalClient {

  private MethodsClient methodsClient;

  public SlackClient(final MethodsClient methodsClient) {
    this.methodsClient = slackClient;
  }

  public Channel callChannel(final String channelSlackId) {
    try {
      Conversation conversation = methodsClient.conversationsInfo(
          request -> request.channel(channelSlackId))
        .getChannel();

      return new Channel(conversation.getId(), conversation.getName());

    } catch (IOException | SlackApiException e) {
      throw new SlackApiCallException();
    }
  }
}
```

![](../images/2022-10-10-service-ver3.png)

<br/>

## 3. ìŠ¤í…ìš© ê°ì²´ ìƒì„± ë° ì ìš©

ìŠ¤í…ìš© ê°ì²´ë¥¼ ìƒì„±í•œ ë’¤ `@Component`ë¥¼ ì´ìš©í•´ beanìœ¼ë¡œ ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.

```java

@Primary // SlackClient ë³´ë‹¤ ìš°ì„  ìˆœìœ„ê°€ ë†’ì€ beanìœ¼ë¡œ ë“±ë¡í•˜ê¸° ìœ„í•´ ë¶™ì˜€ë‹¤.
@Component
public class FakeClient implements ExternalClient {

  private List<Channel> channels = List.of( ...); // ì±„ë„ ë°ì´í„° ì´ˆê¸°í™”

  @Override
  public Channel callChannel(final String channelSlackId) {
    return channels.stream()
      .filter(it -> it.isSameSlackId(channelSlackId))
      .findAny()
      .orElseThrow(() -> new SlackApiCallException());
  }
}
```

<br/>

## 4. í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ëª¨í‚¹ ì œê±°

ìŠ¤í…ì„ ì ìš©í•˜ì˜€ìœ¼ë‹ˆ ì´ì œ ëª¨í‚¹í•œ ì½”ë“œë“¤ì„ ì œê±°í•´ì£¼ëŠ” ì¼ë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤.
ì „í›„ ì½”ë“œë¥¼ ë¹„êµí•˜ì—¬ ì½”ë“œê°€ ì–¼ë§ˆë‚˜ ê¹”ë”í•´ì¡ŒëŠ”ì§€ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

#### AS-IS (ëª© ì ìš©)

```java

@Test
void execute() {
  // given
  Workspace workspace = workspaces.save(WorkspaceFixture.JUPJUP.create());
  Channel channel = ChannelFixture.QNA.create(workspace);
  String request = createRequest(channel);

  given(slackClient.conversationsInfo((RequestConfigurator<ConversationsInfoRequestBuilder>) any()))
    .willReturn(setUpChannelMockData(channel));

  // when
  channelCreatedService.execute(request);

  // then
  Optional<Channel> actual = channels.findBySlackId(channel.getSlackId());
  assertThat(actual).isNotEmpty();
}

private ConversationsInfoResponse setUpChannelMockData(final Channel channel) {
  Conversation conversation = new Conversation();
  conversation.setId(channel.getSlackId());
  conversation.setName(channel.getName());

  ConversationsInfoResponse conversationsInfoResponse = new ConversationsInfoResponse();
  conversationsInfoResponse.setChannel(conversation);
  conversationsInfoResponse.setOk(true);

  return conversationsInfoResponse;
}
```

#### TO-BE (ìŠ¤í… ì ìš©)

```java

@Test
void execute() {
  // given
  Workspace workspace = workspaces.save(WorkspaceFixture.JUPJUP.create());
  Channel channel = ChannelFixture.QNA.create(workspace);
  String request = createRequest(channel);

  // when
  channelCreatedService.execute(request);

  // then
  Optional<Channel> actual = channels.findBySlackId(channel.getSlackId());
  assertThat(actual).isNotEmpty();
}
```

<br/><br/>

# ğŸ˜‰ ë§ˆë¬´ë¦¬

í•´ë‹¹ ê¸€ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ê°„í¸í™”í•˜ê¸° ìœ„í•´ ì„œë¹„ìŠ¤ ì¶”ìƒí™”ë¥¼ ì§„í–‰í•´ë³´ì•˜ìŠµë‹ˆë‹¤.
ì„œë¹„ìŠ¤ ì¶”ìƒí™”ëŠ” ì´ ì™¸ì—ë„ ë‹¤ì–‘í•œ ëª©ì ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê°ì²´ ì§€í–¥ì ì¸ ì½”ë“œëŠ” `ë‹¨ì¼ ì±…ì„ ì›ì¹™`ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤.
ê¸°ì¡´ì˜ `ChannelCreateService`ì—ì„œëŠ” 'Slack ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ', 'ì˜ˆì™¸ ì²˜ë¦¬', 'ì±„ë„ ì €ì¥' 3ê°€ì§€ ì—­í• ì„ í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
ê°œì„ ëœ `ChannelCreateService`ì—ì„œëŠ” `SlackClient`ë¥¼ í†µí•´ ì±„ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³  ì´ë¥¼ DBì— 'ì €ì¥'í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
'Slack ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜¸ì¶œ'ê³¼ ì´ë¡œ ì¸í•œ 'ì˜ˆì™¸ ì²˜ë¦¬'ì˜ ì±…ì„ì€ `SlackClient`ìœ¼ë¡œ ì˜®ê²¨ê°”ìŠµë‹ˆë‹¤.
ì´ë ‡ë“¯ ì„œë¹„ìŠ¤ë¥¼ ì¶”ìƒí™”í•˜ë©´ ì´ì „ë³´ë‹¤ **ì½”ë“œê°€ ê°„ê²°**í•´ì§€ê³  ì‘ì—…ì˜ **ëª©ì ì´ ë¶„ëª…**í•˜ê²Œ ë“œëŸ¬ë‚©ë‹ˆë‹¤.

ê° ì˜¤ë¸Œì íŠ¸ì˜ ì±…ì„ê³¼ ì—­í• ì´ ë” ë¶„ëª…í•˜ê²Œ ë¶„ë¦¬ë˜ë©´ ë³€ê²½ ì‚¬í•­ì´ ìƒê¸°ëŠ” ê²½ìš° **ë³€ê²½ í¬ì¸íŠ¸**ë¥¼ ì‰½ê²Œ ì°¾ì•„ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ì œ `Slack ë¼ì´ë¸ŒëŸ¬ë¦¬`ì™€ ê´€ë ¨ëœ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ `ChannelCreateService`ê°€ ì•„ë‹Œ `SlackClient`ë¥¼ ì‚´í”¼ë©´ ë©ë‹ˆë‹¤.
ì˜ì¡´ë˜ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ `Slack`ì´ ì•„ë‹Œ `ì¹´ì¹´ì˜¤í†¡`, `ë¼ì¸` ë“±ìœ¼ë¡œ ë°”ë€” ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
ì´ ê²½ìš°ì—ë„ `ExternalClient`ì˜ êµ¬í˜„ì²´ë¥¼ ìƒì„±í•˜ë©´ ì‰½ê²Œ ëŒ€ì²´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/><br/>

***

### Reference & Source

- í† ë¹„ì˜ ìŠ¤í”„ë§ 3.1 / ì´ì¼ë¯¼
- ëŒ€í‘œ ì´ë¯¸ì§€: í”¼ì—íŠ¸ ëª¬ë“œë¦¬ì•ˆì˜ ì¶”ìƒí™” ì‘ `ë¸Œë¡œë“œì›¨ì´ ë¶€ê¸°ìš°ê¸°`
