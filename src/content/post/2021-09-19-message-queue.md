---
layout: post
title: 메시지 큐에 대해 알아보자!
author: [3기_파피]
tags: ['message-queue']
date: "2021-09-19T12:00:00.000Z"
draft: false
image: ../teaser/message-queue.png
---

<p style="font-family: sans-serif; text-align: center; color: #aaa; margin-bottom: 3em; font-size: 85%">image origin: <a href="https://blog.naver.com/kkumbo1003/222419008116">blog.naver.com/kkumbo1003</a></p>

## 메시지 큐란

메시지 큐(Message 큐:메시지 큐)는 프로세스 또는 프로그램 간에 데이터를 교환할 때 사용하는 통신 방법 중에 하나로, 메시지 지향 미들웨어(Message Oriented Middleware:MOM)를 구현한 시스템을 의미한다. 메시지 지향 미들웨어란 비동기 메시지를 사용하는 응용 프로그램들 사이에서 데이터를 송수신하는 것을 의미한다.
여기서 메시지란 요청, 응답, 오류 메시지 혹은 단순한 정보 등의 작은 데이터가 될 수 있다.

그림을 통해 쉽게 이해해보자. 메시지 큐는 메시지를 임시로 저장하는 간단한 버퍼라고 생각하면 된다. 메시지를 전송 및 수신하기 위해 중간에 메시지 큐를 두는 것이다.

![image](https://user-images.githubusercontent.com/50273712/133918874-2664898b-a080-4df6-bd21-fad7a204029d.png)

메시지 전송 시 생산자(Producer)로 취급되는 컴포넌트가 메시지를 메시지 큐에 추가한다. 해당 메시지는 소비자(Consumer)로 취급되는 또 다른 컴포넌트가 메시지를 검색하고 이를 사용해 어떤 작업을 수행할 때까지 메시지 큐에 저장된다. 각 메시지는 하나의 소비자에 의해 한 번만 처리될 수 있는데, 이러한 이유로 메시지 큐를 이용하는 방식을 일대일 통신이라고 부른다.

## 메시지 큐의 장점

일반적인 클라이언트-서버 구조에서는 사용자가 요청을 하면 서버는 그에 대한 처리를 한 후 클라이언트에게 응답을 한다. 간단한 서버 구조에서는 굳이 메시지 큐를 사용할 필요가 없다. 또한 메시지 큐를 적용하려면 다양한 메시지 큐 중에서 시스템의 목적에 맞는 것을 선정해야 한다. 이후 선정된 메시지 큐의 사용 방법도 익혀야 하며, 지원하는 다양한 옵션 중에 시스템이 추구하는 목적에 맞는 옵션을 찾아 설정해야 한다. 상상만 해도 번거로운 작업들이 수반되는데, 왜 메시지 큐를 사용할까?

먼저, 메시지 큐 미사용 웹 서비스 구조의 예시를 보자.

![image](https://user-images.githubusercontent.com/50273712/133947829-6064b6dd-6fed-4be6-a040-0694bd6f0875.png)

어플리케이션과 데이터베이스의 동기적 직접 통신 구조이다. 어플리케이션과 데이터베이스가 강하게 결합되어 있어 어플리케이션의 요청-응답 과정에서 데이터베이스 서버로의 요청-응답 모두 완료되어야 응답이 가능하다.

따라서 다음과 같은 문제가 발생할 수 있다.
- 데이터베이스의 응답 시간이 길어진다면 어플리케이션 또한 그만큼 응답 시간이 길어진다.
- 데이터베이스 장애 시 어플리케이션이 동작하지 못한다.
- 어플리케이션 입장에서 감당할 수있는 요청 수가 데이터베이스에서는 감당 불가능하다면, 성능 저하나 장애가 발생할 수 있다.

이제 메시지 큐를 사용하는 웹 서비스 구조의 예시를 보자.

![image](https://user-images.githubusercontent.com/50273712/133947930-b5e6eb35-0ae0-4d8d-be6d-ea2858f7eb0c.png)

어플리케이션은 큐에 요청을 쌓고, 데이터베이스는 큐에서 요청을 꺼내 처리하는 구조이다.
- 어플리케이션은 큐에 요청을 보내고, 데이터베이스의 응답을 기다리지 않고 사용자에게 응답을 보낼 수 있다.
- 데이터베이스 장애 발생 시에도 어플리케이션은 독립적으로 동작이 가능하다.
- 어플리케이션과 데이터베이스 사이의 통신을 처리량에 따라 제어할 수 있다.

메시지 큐의 장점을 정리해보면 다음과 같다.

### 비동기(Asynchronous)

메시지 큐는 생산된 메시지의 저장, 전송에 대해 동기화 처리를 진행하지 않고, 큐에 넣어 두기 때문에 나중에 처리할 수 있다.
여기서, 기존 동기화 방식은 많은 메시지(데이터)가 전송될 경우 병목이 생길 수 있고, 뒤에 들어오는 요청에 대한 응답이 지연될 것이다.

### 비동조(Decoupling)

메시지 큐를 따로 둠으로써, 어플리케이션과 분리가 가능하다.

### 약결합 및 탄력성(Resilience)

메시지 큐가 없는 일반적인 웹 서비스 구조의 서버-클라이언트 통신은 결합도가 높은 구조이며, 동기 방식이기 때문에 시스템 내 요소들 간 의존성이 높아 시스템에 많은 영향을 끼치고 유연성이 낮다.
하지만 메시지 큐는 데이터를 큐에 담아 비동기로 처리하기 때문에, 일부 작업이 실패하더라도 시스템 전체에 영향을 주지 않는다.

### 과잉(Redundancy)

실패한 작업에 대한 재실행이 가능하다.

### 보증(Guarantees)

메시지 큐는 들어오고 나가는 작업 처리된 것을 확인 및 관리 할 수 있기 때문에, 에러 감소 및 로직을 보증할 수 있다.

### 확장성(Scalable)

다수의 프로세스들이 메시지 큐를 이용해 메세지를 보낼 수 있기 때문에 확장성 및 분산 처리에 용이하다.

## 메시지 큐의 사용처

메시지 큐는 대용량 데이터를 처리하기 위한 배치 작업이나, 채팅 서비스, 비동기 데이터를 처리할 때 사용한다. 

사용자가 많아지거나 처리할 데이터가 많아지면 요청에 대한 응답을 기다리는 수가 증가하다가 나중에는 대기 시간이 점점 지연되면서 서비스가 정상적으로 동작하지 못하는 상황이 올 수 있기 때문에 중간에 메시지 큐를 두어서 프로그램에 필요한 작업을 분산시키는 것이 그 목적이다.

## 마무리

결국은 서버가 사용자에게 얼마나 빠르고 안정적으로 정보를 전달할 수 있는 지에 초점을 맞춘 기술이라고 생각한다.

모든 어플리케이션에 메시지 큐가 필요한 것은 아니지만, 서버의 뒷단에서 실행되는 일부 작업을 메시지 큐에 맡김으로써 웹 어플리케이션의 성능을 향상시키는 것에 대해 생각해보는 것도 좋을 것이다. 

또한 메시지 큐에도 RabbitMQ, Kafka, ActiveMQ 등과 같은 다양한 오픈소스 시스템이 존재하는데, 각 시스템별 비교 분석 후 현재 도입하고자 하는 서비스에 적합한 시스템을 선정하는 것이 좋다.

## Reference

https://aws.amazon.com/message-queue/

https://www.icelancer.com/2016/12/message-queue.html

https://lion-king.tistory.com/entry/Message큐-메시지 큐-what-is
