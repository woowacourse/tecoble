{"componentChunkName":"component---src-templates-post-tsx","path":"/post/2023-08-16-ObjectOptimisticLockingFailureException/","result":{"data":{"logo":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#080808","images":{"fallback":{"src":"/static/0b18bd94a62a12fdc81ea720c28722f6/a9770/tecoble.png","srcSet":"/static/0b18bd94a62a12fdc81ea720c28722f6/a9770/tecoble.png 400w","sizes":"400px"},"sources":[{"srcSet":"/static/0b18bd94a62a12fdc81ea720c28722f6/65935/tecoble.webp 400w","type":"image/webp","sizes":"400px"}]},"width":500,"height":110}}},"markdownRemark":{"html":"<p>안녕하세요. 우아한테크코스 5기 BE 연어입니다.\n팀 프로젝트에서 열심히 <code class=\"language-text\">요즘카페</code>라는 서비스를 만들고 있습니다.</p>\n<p><a href=\"https://yozm.cafe\">요즘카페</a>는 스크롤 내리면서 성수동의 카페들을 하나씩 볼 수 있는 <strong>숏폼</strong> 형식의 서비스입니다.\n최근에 무한 스크롤 기능을 추가하면서 예상치 못한 동시성 문제를 맞닥뜨렸는데요.</p>\n<p>이 글에서는 <code class=\"language-text\">ObjectOptimisticLockingFailureException</code>이 왜 발생했고, 관련 개념들과 해결 방법에 대해서 다뤄보고자 합니다.</p>\n<p>목차는 아래의 순서와 같습니다.</p>\n<ul>\n<li>문제 발생</li>\n<li>배경 설명</li>\n<li>Entity Manager</li>\n<li>DB Isolation Level</li>\n<li>문제 원인</li>\n<li>해결 방안</li>\n<li>정리</li>\n</ul>\n<h2>문제 발생</h2>\n<p>평소처럼 선릉 캠퍼스에 도착해서 로그를 보고 있었습니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1858px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/1504dbefe3529499a56daf55b8800916/bf7a7/2023-08-16-object-optimistic-locking-failure-exception.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 16%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAjUlEQVR42j1OWw6CMBDsAcCK2AcPQYo0Coh4/8ONu1vixyTzyu4o328o6xcKH3EyD4G2E3nPv+YsKwMuFXuj5NK/jpKfXUROPKeOasMXpp1hmhn2tsL3b/CT6r7DdcQJrlups5C3UWcRXQ8f6TJnvwm7aCXHjoNc4lCbSVbwZ215QdJpYVrEKA4I91E6P3aJT8UmL5ntAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"2023 08 16 object optimistic locking failure exception\" title=\"\" src=\"/static/1504dbefe3529499a56daf55b8800916/bf7a7/2023-08-16-object-optimistic-locking-failure-exception.png\" srcset=\"/static/1504dbefe3529499a56daf55b8800916/0eb09/2023-08-16-object-optimistic-locking-failure-exception.png 500w,\n/static/1504dbefe3529499a56daf55b8800916/1263b/2023-08-16-object-optimistic-locking-failure-exception.png 1000w,\n/static/1504dbefe3529499a56daf55b8800916/bf7a7/2023-08-16-object-optimistic-locking-failure-exception.png 1858w\" sizes=\"(max-width: 1858px) 100vw, 1858px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>그런데 처음 보는 예외가 발생해 있었고, <strong>어떤 행동을 하면 발생하는지</strong> 알기 위해 이런저런 행동을 해봤습니다.</p>\n<h3>기대했던 동작</h3>\n<ul>\n<li>회원이 스크롤을 엄청 빠르게 내려도</li>\n<li>로그에는 예외가 발생하지 않고</li>\n<li>새 카페가 중복 없이 나온다</li>\n</ul>\n<h3>문제가 발생하는 행동</h3>\n<ul>\n<li>회원이 스크롤을 엄청 빠르게 내리면</li>\n<li>로그에는 위와 같이 <code class=\"language-text\">ObjectOptimisticLockingFailureException</code>이 발생해 있고</li>\n<li>스크롤을 내려도 계속 똑같은 카페 화면이 보인다</li>\n</ul>\n<p><strong>왜 문제가 발생했을까요…?</strong></p>\n<h2>배경 설명</h2>\n<p><a href=\"https://yozm.cafe\">요즘카페</a>에서는 회원에게 <code class=\"language-text\">아직 보여주지 않은 카페</code>들을 우선으로 보여주는 로직이 존재합니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 886px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/85b3661a3c4f181b6965df6359c134f2/6f18b/2023-08-16-unviewed-cafe-erd.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 55.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1ElEQVR42m1Sa3OTUBDlz5gCSQjPAEmJYAwOpKF5TM1ImqRq+pjWjlNHxw/634+7S4no9MNh773cPXv23FXUjgut60FtO3D8GEGUwqbIcMNEohMkaBt9uufS/wm8wfj5/ximdwrhIHBUeKETYUuzUCxKfLx5wu76G/a3P/Dp/ifuvv7GfH2AYQZE6uPq8IgP+wfsbr7j+vEXknRBYmzhYC5FFWYHJ7qNPlUejWcYxjnWmwMm+QpxOsdpkqPd86UTXvP5RfkZEd3lHO7uqFCnj2GF6NkDdEVFn6q5mBYrGHaAV6p5TOC7Ldrb1Oa7rEBLt0QZK+9wQSGkg4iqJpMC8dszhKNU4oC8Et8a/tReda2AioV4k55L7mg8xYDyuLBSXzyhDXtR77lFL4yhy2N4Fei8Q114wWuKfuVbA2rtodaoXr26K57a/UhUssd1UYPUme6Q2v1b/J9XVl9oySA/Gayw5wylRQarMr0ILiu0fPn3vxilNlt/PmSUu1uUV19wsb3HanOH7eFJsKdReb97wJrAI5UvLsW3Zv6RsCZjXybZEtlsjWxeIitKTOcbnC0vBTmtp0Q0W27pIc+hNSZAe6llBg95BVPGpkJPIp/Xe7XhY93yH75SbaMnRXObAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"2023 08 16 unviewed cafe erd\" title=\"\" src=\"/static/85b3661a3c4f181b6965df6359c134f2/6f18b/2023-08-16-unviewed-cafe-erd.png\" srcset=\"/static/85b3661a3c4f181b6965df6359c134f2/0eb09/2023-08-16-unviewed-cafe-erd.png 500w,\n/static/85b3661a3c4f181b6965df6359c134f2/6f18b/2023-08-16-unviewed-cafe-erd.png 886w\" sizes=\"(max-width: 886px) 100vw, 886px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span>\n<p>회원마다 아직 보지 않은 카페 목록 <code class=\"language-text\">UnViewedCafe</code>를 가지고 있습니다.\n이는 <code class=\"language-text\">Member:Cafe = N:M</code> 인 다대다 관계를 중간에서 <code class=\"language-text\">1:N, M:1</code> 로 해결해 주는 테이블입니다.</p>\n<p>회원이 스크롤을 내릴 때마다 새로운 카페들을 보여주게 되는데 이때 아래의 두 API가 필요합니다.</p>\n<h4>A. 회원이 아직 보지 않은 카페 목록을 조회하는 API</h4>\n<p>회원이 다음 카페를 보기 위해 스크롤을 내리면, 아직 보지 않은 카페들 중 랜덤으로 <strong>5</strong>개를 응답으로 보내줍니다.\n해당 회원의 <code class=\"language-text\">UnViewedCafe</code> 테이블에서 5개를 조회해 와서 그대로 리턴하는 방식입니다.</p>\n<h4>B. 회원이 해당 카페를 봤다는 처리를 하기 위한 API</h4>\n<p>회원이 다음 카페를 보기 위해 스크롤을 내리면, 해당 카페 ID를 서버로 보내서 <code class=\"language-text\">UnViewedCafe</code> 테이블에서 제거합니다\n<code class=\"language-text\">UnViewedCafe</code> 테이블에서 (memberId, cafeId) 조합의 데이터를 삭제하는 방식입니다.\n또한 해당 회원의 <code class=\"language-text\">UnViewedCafe</code>가 0개가 됐을 때는 전체 카페들을 가져와서 다시 채워줍니다. 따라서 무한 스크롤이 가능해지게 됩니다.</p>\n<p>위의 두 API를 가지고 <strong>프론트엔드</strong>에서는 아래와 같은 방식으로 동작합니다.</p>\n<ul>\n<li><strong>카페 목록에서 스크롤을 내려 추가로 볼 수 있는 남은 카페가 3개 이하</strong>일 때마다 <strong>A</strong>를 요청합니다.</li>\n<li>스크롤을 내려 다음 카페를 볼 때마다 <strong>B</strong>를 요청합니다.</li>\n</ul>\n<p>대체 왜 <code class=\"language-text\">ObjectOptimisticLockingFailureException</code>이 발생했고, 스크롤을 내려도 똑같은 카페 화면만 보였을까요?\n이유를 알기 위해서 먼저 <code class=\"language-text\">JPA의 Entity Manager</code>, <code class=\"language-text\">DB Isolation Level</code>에 대해 알아야 합니다.\n아래에서 하나씩 간단히 살펴보겠습니다.</p>\n<h2>Entity Manager</h2>\n<p>JPA를 쓰신다면 다들 들어보셨을 용어입니다.</p>\n<p>Spring Data JPA를 사용하신다면 보통 아래의 방법들로 DB와 소통할 것입니다.</p>\n<ul>\n<li>JPA Repository Interface</li>\n<li>JPQL</li>\n<li>Native Query</li>\n<li>Entity Manager</li>\n</ul>\n<p>위의 방법들은 공통점이 있습니다.\nSpring Container에서 관리되는 <code class=\"language-text\">Entity Manager</code>를 통해 쿼리를 수행한다는 점인데요.</p>\n<p>그럼 이제부터 이 <code class=\"language-text\">Entity Manager</code>의 특징에 대해서 하나씩 살펴봅시다.</p>\n<h4><code class=\"language-text\">Entity Manager</code>는 항상 트랜잭션 내에서 동작합니다.</h4>\n<p>보통 서비스 레이어에서 <code class=\"language-text\">@Transactional</code>으로 메서드를 하나의 작업 단위로 관리하는데요.\n이때 내부적으로 하나의 <code class=\"language-text\">Entity Manager</code>가 할당되고 이 <code class=\"language-text\">Entity Manager</code>가 영속성 컨텍스트, 실제 DB와 소통하게 됩니다.</p>\n<h4><code class=\"language-text\">Entity Manager</code>는 싱글톤이 아닙니다.</h4>\n<p>기본적으로 멀티 스레드 방식으로 동작하는 스프링을 사용할 때 여러 요청을 동시에 처리합니다.\n이때 실제 DB와 소통하는 <code class=\"language-text\">Entity Manager</code>를 싱글톤으로 쓴다면 여러 동시성 문제가 발생할 수 있겠죠?</p>\n<p>따라서 Spring에서는 DB와 연결을 관리하는 객체인 <code class=\"language-text\">Entity Manager Factory</code>를 싱글톤으로 관리합니다.\n그리고 <code class=\"language-text\">Entity Manager</code>가 필요할 때마다 <code class=\"language-text\">Entity Manager Factory</code>가 생성하는 방식으로 다수의 <code class=\"language-text\">Entity Manager</code> 인스턴스를 관리합니다.</p>\n<h4><code class=\"language-text\">Entity Manager</code>는 자신만의 1차 캐시를 관리합니다.</h4>\n<p>JPA를 쓸 때 변경 감지를 사용하시나요?\n<strong>쓰기 트랜잭션</strong> 범위 내에서 <strong>영속 상태의 인스턴스</strong>는 스냅샷이 관리됩니다.\n<code class=\"language-text\">Entity Manager</code>는 이 스냅샷을 관리하다가 최종적으로 트랜잭션이 커밋될 때 DB로 Flush 해줍니다.</p>\n<h4>정리해 보면,</h4>\n<p><code class=\"language-text\">Entity Manager Factory</code>에서 관리하는 <code class=\"language-text\">Entity Manager</code>는 트랜잭션별로 생성되고 소멸합니다.\n또한 1차 캐시를 각각 생성해서 관리합니다.\n따라서 한 엔티티를 여러 스레드에서 동시에 수정해도 자신들만의 캐시에서 관리하기 때문에 서로 간섭이 없습니다.</p>\n<p>그렇다면 동시에 아무리 요청이 많이 들어와도 동시성 이슈가 없지 않나요?</p>\n<h4>문제는 1차 캐시에서 DB로 Flush될 때 발생합니다.</h4>\n<p>Spring Data JPA의 기본 구현체인 Hibernate는 Flush를 한 이후 실제 DB에서 영향 받은 데이터의 수를 리턴 받습니다.</p>\n<p>이때, 기존 상태에서 예상되는 <strong>변경할 데이터의 수</strong>와 <strong>실제 변경된 데이터의 수</strong>가 다르면 <code class=\"language-text\">StaleObjectStateException</code>이 Hibernate에서 발생합니다.\n그리고 위 런타임 예외가 JPA 레벨로 올라오면, <strong>더 일반적인 예외인 <code class=\"language-text\">ObjectOptimisitcLockingFailureException</code>으로 Wrapping</strong> 됩니다.</p>\n<p><strong>동시에 여러 요청이 동일한 데이터를 변경하려고 할 때</strong>, Application 레벨에서는 문제가 없지만 DB로 Flush될 때 발생하게 되겠죠?</p>\n<h2>DB Isolation Level</h2>\n<p>데이터베이스에는 **격리 수준(Isolation Level)**이라는 개념이 존재합니다.\n이는 트랜잭션의 작업이 다른 트랜잭션의 작업과 어떤 관계를 맺는지 정의합니다.</p>\n<p>간단히 살펴보면 크게 4가지 단계가 있습니다. (더 자세한 설명은 <a href=\"https://tecoble.techcourse.co.kr/post/2022-11-07-mysql-isolation/\">트랜잭션 격리 수준</a>에서 보실 수 있습니다.)</p>\n<ul>\n<li><strong>Uncommitted Read</strong>\n<ul>\n<li>다른 트랜잭션에서 현재 수정 중인 내용도 볼 수 있습니다.</li>\n</ul>\n</li>\n<li><strong>Committed Read</strong>\n<ul>\n<li>다른 트랜잭션에서 커밋을 하면, 그 내용도 볼 수 있습니다.</li>\n</ul>\n</li>\n<li><strong>Repeatable Read</strong>\n<ul>\n<li>한 번 읽어온 정보에 대해서는, 다른 트랜잭션에서 수정하더라도 이전에 읽었던 상태로 보입니다.</li>\n</ul>\n</li>\n<li><strong>Serializable</strong>\n<ul>\n<li>읽어온 정보에 대해서 현재 트랜잭션이 끝날 때까지, 다른 트랜잭션에서는 읽기조차 불가능합니다.</li>\n</ul>\n</li>\n</ul>\n<p>저희는 어떤 격리 수준을 사용하고 있을까요?\n이를 위해 저희가 사용하는 MySQL에 대해서도 간단하게 살펴봅시다.</p>\n<p>MySQL은 <strong>MySQL 엔진</strong>과 <strong>스토리지 엔진</strong>으로 구현돼 있습니다.\n간단히 <strong>MySQL 엔진은 핵심 본체</strong>이고, <strong>스토리지 엔진은 주로 읽기, 쓰기 등의 작업을 처리하는 일꾼</strong>입니다.</p>\n<p>스토리지 엔진은 여러 종류가 있고, MySQL에서도 여러 가지를 기본으로 제공하는데요.\n<strong>테이블 별로 어떤 스토리지 엔진</strong>을 사용할지 설정할 수 있습니다.\n<strong>MySQL에서는 기본적으로</strong> 테이블을 만들 때 스토리지 엔진을 지정하지 않으면, <strong>InnoDB 스토리지 엔진</strong>을 사용하게 됩니다.</p>\n<p>그리고 <strong>격리 수준은 각 트랜잭션별로 설정</strong>할 수 있습니다.\n<strong>InnoDB에서는</strong> 트랜잭션을 수행할 때 격리 수준을 따로 지정하지 않으면, <strong>Repeatable Read</strong> 수준을 사용하게 됩니다.</p>\n<p>결론은 <strong>Repeatable Read</strong> 특성상 <strong>최초 조회한 시점 이후</strong>로 어떤 수정이 발생해도 똑같은 결과만 보이게 되겠죠?</p>\n<h2>드디어 살펴보는 문제 원인</h2>\n<p>여기까지 먼 길 오시느라 고생하셨습니다!</p>\n<p>다시 문제를 리마인드 해봅시다.</p>\n<blockquote>\n<p>회원이 스크롤을 엄청 빠르게 내리면\n<strong>ObjectOptimisticLockingFailureException</strong> 예외가 발생해 있고\n스크롤을 내려도 <strong>계속 똑같은 카페 화면</strong>이 보인다</p>\n</blockquote>\n<p>먼저 <strong>프론트엔드</strong>에서는 아래와 같은 방식으로 동작합니다.</p>\n<ul>\n<li>회원이 스크롤을 내려서 다음 카페를 조회할 때마다 서버에게 해당 카페를 봤다는 요청을 합니다.</li>\n<li>스크롤을 내려 추가로 볼 수 있는 남은 카페가 3개 이하일 때마다 서버에게 다음 카페 5개를 요청합니다.</li>\n</ul>\n<h4>그리고 서버의 <code class=\"language-text\">UnViewedCafe</code> 테이블에 해당 회원의 남은 카페가 3개일 경우를 생각해 봅시다.</h4>\n<ul>\n<li>스크롤을 내릴 때, 추가로 볼 수 있는 남은 카페 목록이 3개 이하라면 다음 카페 조회 요청을 보냅니다.\n<ul>\n<li>이때 스크롤 속도가 빠르다면 남은 카페 목록이 3개, 2개, 1개일 때 다음 카페 요청을 동시에 3번 보내게 됩니다.</li>\n<li>또한 스크롤을 내리면서 조회한 카페를 봤다는 요청을 동시에 3번 보냅니다.</li>\n</ul>\n</li>\n</ul>\n<p>위의 상황에서</p>\n<ul>\n<li>서버는 봤다는 요청이 들어올 때마다 해당 카페를 회원의 <code class=\"language-text\">UnViewedCafe</code> 테이블에서 제거합니다.\n<ul>\n<li>마지막 1개의 카페가 제거되어 0개가 됐을 때, 새로 전체 카페 목록을 회원의 <code class=\"language-text\">UnViewedCafe</code>에 채웁니다.</li>\n</ul>\n</li>\n<li>서버는 다음 카페 조회 요청이 들어올 때, 남아 있는 카페들을 보냅니다.\n<ul>\n<li>봤다는 요청이 처리되는 시점에 따라 동일한 3개를 3번 보냈을 수도 있고 3개, 2개, 2개를 보냈을 수도 있고 2개, 2개, 1개를 보냈을 수도 있습니다.</li>\n</ul>\n</li>\n</ul>\n<h4>위의 행동들이 어떠한 순서로 처리될지는 매번 다릅니다.</h4>\n<p>결론적으로 발생하는 문제는 아래와 같습니다.</p>\n<ul>\n<li>회원이 스크롤을 움직일 때마다 동일한 카페에 대해서 봤다는 요청이 동시에 발생할 수 있습니다.\n<ul>\n<li><code class=\"language-text\">ObjectOptimisticLockingFailureException</code>이 발생합니다.</li>\n</ul>\n</li>\n<li>스크롤을 내려도 새로 카페가 채워지지 않은 시점이라면 2개, 1개의 카페만 계속해서 보일 수 있습니다.\n<ul>\n<li>서버에서 회원의 <code class=\"language-text\">UnViewedCafe</code> 목록에 새 카페가 채워질 때까지(해당 <strong>트랜잭션이 커밋되기 전</strong>까지) 계속해서 동일한 카페들만 응답하게 됩니다.</li>\n</ul>\n</li>\n</ul>\n<h2>해결 방안</h2>\n<p>문제를 해결하기 위한 두 선택지가 있었습니다.</p>\n<ol>\n<li>Serializable 격리 수준 사용하기</li>\n<li>조회 요청 때 <code class=\"language-text\">UnViewedCafe</code>에서 다음 카페들을 제거하고 응답하기</li>\n</ol>\n<h4>1. Serializable 격리 수준 사용하기</h4>\n<p>Serializable 격리 수준을 사용한다면, 제일 먼저 도착한 첫 요청만 처리되고 나머지 요청은 기다렸다가 처리될 수 있습니다.\n하지만 이는 매우 비효율적인 방안입니다.</p>\n<p>한 가지 극단적 예시를 보자면 아래와 같습니다.\n카페를 제거하려고 할 때, 해당 카페를 조회하고 있는 회원이 있거나 새로 카페 목록이 채워지는 회원이 존재하면 평생 제거가 불가능합니다.</p>\n<h4>2. 조회 요청 때 <code class=\"language-text\">UnViewedCafe</code>에서 다음 카페들을 제거하고 응답하기</h4>\n<p>이 글을 보시는 여러분은 아래와 같은 의문이 들었을 수 있을 것 같습니다.</p>\n<blockquote>\n<p>왜 저런 식으로 카페를 봤다는 처리를 하지…?\n그냥 조회 요청 때 <code class=\"language-text\">UnViewedCafe</code>에서 제거하면서 응답하면 되지 않았나?</p>\n</blockquote>\n<p>이렇게 구현했다면,\n조회 요청이 동시에 들어와도 가장 먼저 도착한 요청이 남은 카페 목록을 제거하고 응답받았을 것입니다.\n그리고 다른 요청들은 예외가 발생하고 500으로 응답받게 됩니다.\n사용자 입장에서는 첫 요청의 응답으로 카페들을 잘 받았기 때문에 예외가 발생해도 지장이 없습니다.</p>\n<p>하지만 사용 도중에 브라우저를 종료하면 아직 보지 않은 카페는 <code class=\"language-text\">UnviewedCafe</code>가 새로 채워질 때까지 볼 수 없습니다.\n이러한 상황이 반복되면 불행하게도 평생 못 보는 카페가 생길 수도 있습니다.</p>\n<p><code class=\"language-text\">무한 스크롤</code> 기능을 구현할 때 이 방식을 먼저 고려했으나 회원이 특정 카페를 못 보게 되는 경험은 막아야 한다고 생각했기 때문에 선택하지 않았습니다.</p>\n<h4>선택과 근거</h4>\n<p>각 해결 방안의 트레이드 오프를 고려해 본 결과, 2번 방안(조회 요청 때 <code class=\"language-text\">UnViewedCafe</code>에서 다음 카페들을 제거하고 응답하기)을 선택하게 되었습니다.</p>\n<p>회원이 특정 카페를 평생 보지 못할 수도 있다는 단점이 존재하나, 스크롤을 내릴 때 계속 같은 카페만 보이는 상황이 더 문제 된다고 판단했습니다. 회원 스스로는 특정 카페를 보지 못했다는 사실을 인지하기 어렵지만, 같은 카페만 보이는 경험은 사용자가 인지할 수 있는 단점이기에 사용자 이탈률로 직결됩니다.</p>\n<p>따라서 2번 방안인 <strong>조회 요청 때 <code class=\"language-text\">UnViewedCafe</code>에서 다음 카페들을 제거하고 응답하는 방식</strong>으로 로직을 개선했습니다.</p>\n<ul>\n<li>봤다는 요청 API를 제거하고 조회 요청 때 삭제하고 응답하도록 변경했습니다.\n<ul>\n<li>더 이상 중복된 카페 화면이 나오지 않습니다.</li>\n</ul>\n</li>\n<li>남은 <code class=\"language-text\">UnViewedCafe</code>가 0개일 때 새로 채우지 않고, 20개 이하일 때 채웁니다.\n<ul>\n<li>카페를 다시 채울 때까지 기다려야 하는 경우가 줄어듭니다.</li>\n</ul>\n</li>\n<li>새로 카페를 채울 때 <code class=\"language-text\">UnViewedCafe</code>에 남아 있는 카페는 중복해서 추가하지 않습니다.\n<ul>\n<li>새로 채웠을 때 기존 리스트와 중복된 카페가 연속으로 보일 수 있는 상황이 발생하지 않습니다.</li>\n</ul>\n</li>\n</ul>\n<p>하지만 <code class=\"language-text\">StaleObjectStateException</code>에 대해 깔끔하게 해결하지 못한 상황입니다.\n여전히 조회 요청이 동시에 온다면 이후 트랜잭션들은 예외가 발생하고 롤백 됩니다.\n<code class=\"language-text\">UnViewedCafe</code> 테이블의 동일한 데이터를 동시에 제거하려고 했기 때문입니다.</p>\n<h4>위의 남은 문제를 해결하려면 어떤 방법이 있을까요?</h4>\n<p>DB의 처리 속도를 개선해서 문제 발생 확률을 줄일 수도 있고, 격리 수준을 조정하거나 비관적 락, 낙관적 락 등을 사용할 수도 있습니다.</p>\n<p>하지만 동시성 문제를 해결하는 방법은 간단하지 않습니다.\n제시한 방법들을 사용해도 완벽히 해결하지 못할 수도 있고, 다른 문제들이 발생할 수 있습니다.</p>\n<p>저희는 회원의 경험을 최우선시하는 방향으로 아래의 대안을 생각해 봤습니다.</p>\n<ul>\n<li>엔티티에 버전을 매기는 낙관적 락을 사용해서 충돌을 감지합니다.</li>\n<li>충돌이 감지되면 해당 트랜잭션을 재시도 합니다.</li>\n</ul>\n<p>이제 <code class=\"language-text\">StaleObjectStateException</code>이 발생해도 재시도하므로 롤백 문제를 해결할 수 있게 됐군요.\n회원 입장에서는 요청의 재시도 여부와 관계없이 항상 카페를 조회할 수 있습니다. 👍</p>\n<h2>정리</h2>\n<p>지금까지 무한 스크롤 기능에서 발생한 동시성 이슈를 살펴봤습니다.\nDB에서 동일한 데이터를 제거하려고 할 때 <code class=\"language-text\">StaleObjectStateException</code>이 발생하는 것이 원인이었습니다.</p>\n<p>서버 측에서 이를 해결하기 위해 아래의 방법들을 살펴봤습니다.</p>\n<ol>\n<li><code class=\"language-text\">Serializable</code> 격리 수준 사용</li>\n<li>비즈니스 로직 변경</li>\n</ol>\n<p>2번을 선택해서 예외가 발생하는 확률을 훨씬 줄이고 성능은 그대로 유지할 수 있었습니다.\n그러나 근본적인 문제인 <code class=\"language-text\">StaleObjectStateExcpetion</code>은 해결되지 않았고, 추가로 낙관적 잠금을 사용하게 됐습니다.</p>\n<p>위의 방법이 모든 상황에서 정답은 아닙니다.</p>\n<p>각자가 Trade-Off 사이에서 고민한 선택이 결과적으로도 최고의 선택이었기를 바랍니다.\n지금까지 긴 글 읽어주셔서 정말 감사합니다😃\n다 같이 힘내서 더 성장해 보아요🤍</p>\n<h2>참고</h2>\n<ul>\n<li>백은빈, 이성욱 지음, Real MySQL 8.0</li>\n<li><a href=\"https://docs.oracle.com/javaee/7/tutorial/persistence-intro003.htm#BNBQW\">Managing Entities</a></li>\n<li><a href=\"https://www.digitalocean.com/community/tutorials/hibernate-caching-first-level-cache\">Hibernate Caching</a></li>\n</ul>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"안녕하세요. 우아한테크코스 5기 BE 연어입니다.\n팀 프로젝트에서 열심히 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"요즘카페"}]},{"type":"text","value":"라는 서비스를 만들고 있습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://yozm.cafe"},"children":[{"type":"text","value":"요즘카페"}]},{"type":"text","value":"는 스크롤 내리면서 성수동의 카페들을 하나씩 볼 수 있는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"숏폼"}]},{"type":"text","value":" 형식의 서비스입니다.\n최근에 무한 스크롤 기능을 추가하면서 예상치 못한 동시성 문제를 맞닥뜨렸는데요."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이 글에서는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ObjectOptimisticLockingFailureException"}]},{"type":"text","value":"이 왜 발생했고, 관련 개념들과 해결 방법에 대해서 다뤄보고자 합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"목차는 아래의 순서와 같습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"문제 발생"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"배경 설명"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"DB Isolation Level"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"문제 원인"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"해결 방안"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"정리"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"문제 발생"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"평소처럼 선릉 캠퍼스에 도착해서 로그를 보고 있었습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1858px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/1504dbefe3529499a56daf55b8800916/bf7a7/2023-08-16-object-optimistic-locking-failure-exception.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 16%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAjUlEQVR42j1OWw6CMBDsAcCK2AcPQYo0Coh4/8ONu1vixyTzyu4o328o6xcKH3EyD4G2E3nPv+YsKwMuFXuj5NK/jpKfXUROPKeOasMXpp1hmhn2tsL3b/CT6r7DdcQJrlups5C3UWcRXQ8f6TJnvwm7aCXHjoNc4lCbSVbwZ215QdJpYVrEKA4I91E6P3aJT8UmL5ntAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"2023 08 16 object optimistic locking failure exception","title":"","src":"/static/1504dbefe3529499a56daf55b8800916/bf7a7/2023-08-16-object-optimistic-locking-failure-exception.png","srcSet":["/static/1504dbefe3529499a56daf55b8800916/0eb09/2023-08-16-object-optimistic-locking-failure-exception.png 500w","/static/1504dbefe3529499a56daf55b8800916/1263b/2023-08-16-object-optimistic-locking-failure-exception.png 1000w","/static/1504dbefe3529499a56daf55b8800916/bf7a7/2023-08-16-object-optimistic-locking-failure-exception.png 1858w"],"sizes":"(max-width: 1858px) 100vw, 1858px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그런데 처음 보는 예외가 발생해 있었고, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"어떤 행동을 하면 발생하는지"}]},{"type":"text","value":" 알기 위해 이런저런 행동을 해봤습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"기대했던 동작"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"회원이 스크롤을 엄청 빠르게 내려도"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"로그에는 예외가 발생하지 않고"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"새 카페가 중복 없이 나온다"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"문제가 발생하는 행동"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"회원이 스크롤을 엄청 빠르게 내리면"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"로그에는 위와 같이 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ObjectOptimisticLockingFailureException"}]},{"type":"text","value":"이 발생해 있고"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"스크롤을 내려도 계속 똑같은 카페 화면이 보인다"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"왜 문제가 발생했을까요…?"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"배경 설명"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://yozm.cafe"},"children":[{"type":"text","value":"요즘카페"}]},{"type":"text","value":"에서는 회원에게 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"아직 보여주지 않은 카페"}]},{"type":"text","value":"들을 우선으로 보여주는 로직이 존재합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 886px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/85b3661a3c4f181b6965df6359c134f2/6f18b/2023-08-16-unviewed-cafe-erd.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 55.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB1ElEQVR42m1Sa3OTUBDlz5gCSQjPAEmJYAwOpKF5TM1ImqRq+pjWjlNHxw/634+7S4no9MNh773cPXv23FXUjgut60FtO3D8GEGUwqbIcMNEohMkaBt9uufS/wm8wfj5/ximdwrhIHBUeKETYUuzUCxKfLx5wu76G/a3P/Dp/ifuvv7GfH2AYQZE6uPq8IgP+wfsbr7j+vEXknRBYmzhYC5FFWYHJ7qNPlUejWcYxjnWmwMm+QpxOsdpkqPd86UTXvP5RfkZEd3lHO7uqFCnj2GF6NkDdEVFn6q5mBYrGHaAV6p5TOC7Ldrb1Oa7rEBLt0QZK+9wQSGkg4iqJpMC8dszhKNU4oC8Et8a/tReda2AioV4k55L7mg8xYDyuLBSXzyhDXtR77lFL4yhy2N4Fei8Q114wWuKfuVbA2rtodaoXr26K57a/UhUssd1UYPUme6Q2v1b/J9XVl9oySA/Gayw5wylRQarMr0ILiu0fPn3vxilNlt/PmSUu1uUV19wsb3HanOH7eFJsKdReb97wJrAI5UvLsW3Zv6RsCZjXybZEtlsjWxeIitKTOcbnC0vBTmtp0Q0W27pIc+hNSZAe6llBg95BVPGpkJPIp/Xe7XhY93yH75SbaMnRXObAAAAAElFTkSuQmCC'); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"2023 08 16 unviewed cafe erd","title":"","src":"/static/85b3661a3c4f181b6965df6359c134f2/6f18b/2023-08-16-unviewed-cafe-erd.png","srcSet":["/static/85b3661a3c4f181b6965df6359c134f2/0eb09/2023-08-16-unviewed-cafe-erd.png 500w","/static/85b3661a3c4f181b6965df6359c134f2/6f18b/2023-08-16-unviewed-cafe-erd.png 886w"],"sizes":"(max-width: 886px) 100vw, 886px","style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy","decoding":"async"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"회원마다 아직 보지 않은 카페 목록 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"를 가지고 있습니다.\n이는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Member:Cafe = N:M"}]},{"type":"text","value":" 인 다대다 관계를 중간에서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"1:N, M:1"}]},{"type":"text","value":" 로 해결해 주는 테이블입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"회원이 스크롤을 내릴 때마다 새로운 카페들을 보여주게 되는데 이때 아래의 두 API가 필요합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"A. 회원이 아직 보지 않은 카페 목록을 조회하는 API"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"회원이 다음 카페를 보기 위해 스크롤을 내리면, 아직 보지 않은 카페들 중 랜덤으로 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"5"}]},{"type":"text","value":"개를 응답으로 보내줍니다.\n해당 회원의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 테이블에서 5개를 조회해 와서 그대로 리턴하는 방식입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"B. 회원이 해당 카페를 봤다는 처리를 하기 위한 API"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"회원이 다음 카페를 보기 위해 스크롤을 내리면, 해당 카페 ID를 서버로 보내서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 테이블에서 제거합니다\n"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 테이블에서 (memberId, cafeId) 조합의 데이터를 삭제하는 방식입니다.\n또한 해당 회원의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"가 0개가 됐을 때는 전체 카페들을 가져와서 다시 채워줍니다. 따라서 무한 스크롤이 가능해지게 됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위의 두 API를 가지고 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"프론트엔드"}]},{"type":"text","value":"에서는 아래와 같은 방식으로 동작합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"카페 목록에서 스크롤을 내려 추가로 볼 수 있는 남은 카페가 3개 이하"}]},{"type":"text","value":"일 때마다 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"A"}]},{"type":"text","value":"를 요청합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"스크롤을 내려 다음 카페를 볼 때마다 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"B"}]},{"type":"text","value":"를 요청합니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"대체 왜 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ObjectOptimisticLockingFailureException"}]},{"type":"text","value":"이 발생했고, 스크롤을 내려도 똑같은 카페 화면만 보였을까요?\n이유를 알기 위해서 먼저 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"JPA의 Entity Manager"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"DB Isolation Level"}]},{"type":"text","value":"에 대해 알아야 합니다.\n아래에서 하나씩 간단히 살펴보겠습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"JPA를 쓰신다면 다들 들어보셨을 용어입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Spring Data JPA를 사용하신다면 보통 아래의 방법들로 DB와 소통할 것입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"JPA Repository Interface"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"JPQL"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Native Query"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위의 방법들은 공통점이 있습니다.\nSpring Container에서 관리되는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"를 통해 쿼리를 수행한다는 점인데요."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그럼 이제부터 이 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"의 특징에 대해서 하나씩 살펴봅시다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"는 항상 트랜잭션 내에서 동작합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"보통 서비스 레이어에서 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"@Transactional"}]},{"type":"text","value":"으로 메서드를 하나의 작업 단위로 관리하는데요.\n이때 내부적으로 하나의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"가 할당되고 이 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"가 영속성 컨텍스트, 실제 DB와 소통하게 됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"는 싱글톤이 아닙니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"기본적으로 멀티 스레드 방식으로 동작하는 스프링을 사용할 때 여러 요청을 동시에 처리합니다.\n이때 실제 DB와 소통하는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"를 싱글톤으로 쓴다면 여러 동시성 문제가 발생할 수 있겠죠?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서 Spring에서는 DB와 연결을 관리하는 객체인 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager Factory"}]},{"type":"text","value":"를 싱글톤으로 관리합니다.\n그리고 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"가 필요할 때마다 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager Factory"}]},{"type":"text","value":"가 생성하는 방식으로 다수의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":" 인스턴스를 관리합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"는 자신만의 1차 캐시를 관리합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"JPA를 쓸 때 변경 감지를 사용하시나요?\n"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"쓰기 트랜잭션"}]},{"type":"text","value":" 범위 내에서 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"영속 상태의 인스턴스"}]},{"type":"text","value":"는 스냅샷이 관리됩니다.\n"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"는 이 스냅샷을 관리하다가 최종적으로 트랜잭션이 커밋될 때 DB로 Flush 해줍니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"정리해 보면,"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager Factory"}]},{"type":"text","value":"에서 관리하는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Entity Manager"}]},{"type":"text","value":"는 트랜잭션별로 생성되고 소멸합니다.\n또한 1차 캐시를 각각 생성해서 관리합니다.\n따라서 한 엔티티를 여러 스레드에서 동시에 수정해도 자신들만의 캐시에서 관리하기 때문에 서로 간섭이 없습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그렇다면 동시에 아무리 요청이 많이 들어와도 동시성 이슈가 없지 않나요?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"문제는 1차 캐시에서 DB로 Flush될 때 발생합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Spring Data JPA의 기본 구현체인 Hibernate는 Flush를 한 이후 실제 DB에서 영향 받은 데이터의 수를 리턴 받습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이때, 기존 상태에서 예상되는 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"변경할 데이터의 수"}]},{"type":"text","value":"와 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"실제 변경된 데이터의 수"}]},{"type":"text","value":"가 다르면 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"StaleObjectStateException"}]},{"type":"text","value":"이 Hibernate에서 발생합니다.\n그리고 위 런타임 예외가 JPA 레벨로 올라오면, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"더 일반적인 예외인 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ObjectOptimisitcLockingFailureException"}]},{"type":"text","value":"으로 Wrapping"}]},{"type":"text","value":" 됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"동시에 여러 요청이 동일한 데이터를 변경하려고 할 때"}]},{"type":"text","value":", Application 레벨에서는 문제가 없지만 DB로 Flush될 때 발생하게 되겠죠?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"DB Isolation Level"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"데이터베이스에는 **격리 수준(Isolation Level)**이라는 개념이 존재합니다.\n이는 트랜잭션의 작업이 다른 트랜잭션의 작업과 어떤 관계를 맺는지 정의합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"간단히 살펴보면 크게 4가지 단계가 있습니다. (더 자세한 설명은 "},{"type":"element","tagName":"a","properties":{"href":"https://tecoble.techcourse.co.kr/post/2022-11-07-mysql-isolation/"},"children":[{"type":"text","value":"트랜잭션 격리 수준"}]},{"type":"text","value":"에서 보실 수 있습니다.)"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Uncommitted Read"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"다른 트랜잭션에서 현재 수정 중인 내용도 볼 수 있습니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Committed Read"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"다른 트랜잭션에서 커밋을 하면, 그 내용도 볼 수 있습니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Repeatable Read"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"한 번 읽어온 정보에 대해서는, 다른 트랜잭션에서 수정하더라도 이전에 읽었던 상태로 보입니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Serializable"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"읽어온 정보에 대해서 현재 트랜잭션이 끝날 때까지, 다른 트랜잭션에서는 읽기조차 불가능합니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"저희는 어떤 격리 수준을 사용하고 있을까요?\n이를 위해 저희가 사용하는 MySQL에 대해서도 간단하게 살펴봅시다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"MySQL은 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"MySQL 엔진"}]},{"type":"text","value":"과 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"스토리지 엔진"}]},{"type":"text","value":"으로 구현돼 있습니다.\n간단히 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"MySQL 엔진은 핵심 본체"}]},{"type":"text","value":"이고, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"스토리지 엔진은 주로 읽기, 쓰기 등의 작업을 처리하는 일꾼"}]},{"type":"text","value":"입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"스토리지 엔진은 여러 종류가 있고, MySQL에서도 여러 가지를 기본으로 제공하는데요.\n"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"테이블 별로 어떤 스토리지 엔진"}]},{"type":"text","value":"을 사용할지 설정할 수 있습니다.\n"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"MySQL에서는 기본적으로"}]},{"type":"text","value":" 테이블을 만들 때 스토리지 엔진을 지정하지 않으면, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"InnoDB 스토리지 엔진"}]},{"type":"text","value":"을 사용하게 됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그리고 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"격리 수준은 각 트랜잭션별로 설정"}]},{"type":"text","value":"할 수 있습니다.\n"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"InnoDB에서는"}]},{"type":"text","value":" 트랜잭션을 수행할 때 격리 수준을 따로 지정하지 않으면, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Repeatable Read"}]},{"type":"text","value":" 수준을 사용하게 됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"결론은 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Repeatable Read"}]},{"type":"text","value":" 특성상 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"최초 조회한 시점 이후"}]},{"type":"text","value":"로 어떤 수정이 발생해도 똑같은 결과만 보이게 되겠죠?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"드디어 살펴보는 문제 원인"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"여기까지 먼 길 오시느라 고생하셨습니다!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"다시 문제를 리마인드 해봅시다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"회원이 스크롤을 엄청 빠르게 내리면\n"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"ObjectOptimisticLockingFailureException"}]},{"type":"text","value":" 예외가 발생해 있고\n스크롤을 내려도 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"계속 똑같은 카페 화면"}]},{"type":"text","value":"이 보인다"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"먼저 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"프론트엔드"}]},{"type":"text","value":"에서는 아래와 같은 방식으로 동작합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"회원이 스크롤을 내려서 다음 카페를 조회할 때마다 서버에게 해당 카페를 봤다는 요청을 합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"스크롤을 내려 추가로 볼 수 있는 남은 카페가 3개 이하일 때마다 서버에게 다음 카페 5개를 요청합니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"그리고 서버의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 테이블에 해당 회원의 남은 카페가 3개일 경우를 생각해 봅시다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"스크롤을 내릴 때, 추가로 볼 수 있는 남은 카페 목록이 3개 이하라면 다음 카페 조회 요청을 보냅니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"이때 스크롤 속도가 빠르다면 남은 카페 목록이 3개, 2개, 1개일 때 다음 카페 요청을 동시에 3번 보내게 됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"또한 스크롤을 내리면서 조회한 카페를 봤다는 요청을 동시에 3번 보냅니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위의 상황에서"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"서버는 봤다는 요청이 들어올 때마다 해당 카페를 회원의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 테이블에서 제거합니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"마지막 1개의 카페가 제거되어 0개가 됐을 때, 새로 전체 카페 목록을 회원의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에 채웁니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"서버는 다음 카페 조회 요청이 들어올 때, 남아 있는 카페들을 보냅니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"봤다는 요청이 처리되는 시점에 따라 동일한 3개를 3번 보냈을 수도 있고 3개, 2개, 2개를 보냈을 수도 있고 2개, 2개, 1개를 보냈을 수도 있습니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"위의 행동들이 어떠한 순서로 처리될지는 매번 다릅니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"결론적으로 발생하는 문제는 아래와 같습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"회원이 스크롤을 움직일 때마다 동일한 카페에 대해서 봤다는 요청이 동시에 발생할 수 있습니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ObjectOptimisticLockingFailureException"}]},{"type":"text","value":"이 발생합니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"스크롤을 내려도 새로 카페가 채워지지 않은 시점이라면 2개, 1개의 카페만 계속해서 보일 수 있습니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"서버에서 회원의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 목록에 새 카페가 채워질 때까지(해당 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"트랜잭션이 커밋되기 전"}]},{"type":"text","value":"까지) 계속해서 동일한 카페들만 응답하게 됩니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"해결 방안"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"문제를 해결하기 위한 두 선택지가 있었습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Serializable 격리 수준 사용하기"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"조회 요청 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에서 다음 카페들을 제거하고 응답하기"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"1. Serializable 격리 수준 사용하기"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Serializable 격리 수준을 사용한다면, 제일 먼저 도착한 첫 요청만 처리되고 나머지 요청은 기다렸다가 처리될 수 있습니다.\n하지만 이는 매우 비효율적인 방안입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"한 가지 극단적 예시를 보자면 아래와 같습니다.\n카페를 제거하려고 할 때, 해당 카페를 조회하고 있는 회원이 있거나 새로 카페 목록이 채워지는 회원이 존재하면 평생 제거가 불가능합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"2. 조회 요청 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에서 다음 카페들을 제거하고 응답하기"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이 글을 보시는 여러분은 아래와 같은 의문이 들었을 수 있을 것 같습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"왜 저런 식으로 카페를 봤다는 처리를 하지…?\n그냥 조회 요청 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에서 제거하면서 응답하면 되지 않았나?"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이렇게 구현했다면,\n조회 요청이 동시에 들어와도 가장 먼저 도착한 요청이 남은 카페 목록을 제거하고 응답받았을 것입니다.\n그리고 다른 요청들은 예외가 발생하고 500으로 응답받게 됩니다.\n사용자 입장에서는 첫 요청의 응답으로 카페들을 잘 받았기 때문에 예외가 발생해도 지장이 없습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만 사용 도중에 브라우저를 종료하면 아직 보지 않은 카페는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnviewedCafe"}]},{"type":"text","value":"가 새로 채워질 때까지 볼 수 없습니다.\n이러한 상황이 반복되면 불행하게도 평생 못 보는 카페가 생길 수도 있습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"무한 스크롤"}]},{"type":"text","value":" 기능을 구현할 때 이 방식을 먼저 고려했으나 회원이 특정 카페를 못 보게 되는 경험은 막아야 한다고 생각했기 때문에 선택하지 않았습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"선택과 근거"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"각 해결 방안의 트레이드 오프를 고려해 본 결과, 2번 방안(조회 요청 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에서 다음 카페들을 제거하고 응답하기)을 선택하게 되었습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"회원이 특정 카페를 평생 보지 못할 수도 있다는 단점이 존재하나, 스크롤을 내릴 때 계속 같은 카페만 보이는 상황이 더 문제 된다고 판단했습니다. 회원 스스로는 특정 카페를 보지 못했다는 사실을 인지하기 어렵지만, 같은 카페만 보이는 경험은 사용자가 인지할 수 있는 단점이기에 사용자 이탈률로 직결됩니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"따라서 2번 방안인 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"조회 요청 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에서 다음 카페들을 제거하고 응답하는 방식"}]},{"type":"text","value":"으로 로직을 개선했습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"봤다는 요청 API를 제거하고 조회 요청 때 삭제하고 응답하도록 변경했습니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"더 이상 중복된 카페 화면이 나오지 않습니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"남은 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"가 0개일 때 새로 채우지 않고, 20개 이하일 때 채웁니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"카페를 다시 채울 때까지 기다려야 하는 경우가 줄어듭니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"새로 카페를 채울 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":"에 남아 있는 카페는 중복해서 추가하지 않습니다.\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"새로 채웠을 때 기존 리스트와 중복된 카페가 연속으로 보일 수 있는 상황이 발생하지 않습니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"StaleObjectStateException"}]},{"type":"text","value":"에 대해 깔끔하게 해결하지 못한 상황입니다.\n여전히 조회 요청이 동시에 온다면 이후 트랜잭션들은 예외가 발생하고 롤백 됩니다.\n"},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"UnViewedCafe"}]},{"type":"text","value":" 테이블의 동일한 데이터를 동시에 제거하려고 했기 때문입니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{},"children":[{"type":"text","value":"위의 남은 문제를 해결하려면 어떤 방법이 있을까요?"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"DB의 처리 속도를 개선해서 문제 발생 확률을 줄일 수도 있고, 격리 수준을 조정하거나 비관적 락, 낙관적 락 등을 사용할 수도 있습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"하지만 동시성 문제를 해결하는 방법은 간단하지 않습니다.\n제시한 방법들을 사용해도 완벽히 해결하지 못할 수도 있고, 다른 문제들이 발생할 수 있습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"저희는 회원의 경험을 최우선시하는 방향으로 아래의 대안을 생각해 봤습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"엔티티에 버전을 매기는 낙관적 락을 사용해서 충돌을 감지합니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"충돌이 감지되면 해당 트랜잭션을 재시도 합니다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이제 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"StaleObjectStateException"}]},{"type":"text","value":"이 발생해도 재시도하므로 롤백 문제를 해결할 수 있게 됐군요.\n회원 입장에서는 요청의 재시도 여부와 관계없이 항상 카페를 조회할 수 있습니다. 👍"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"정리"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"지금까지 무한 스크롤 기능에서 발생한 동시성 이슈를 살펴봤습니다.\nDB에서 동일한 데이터를 제거하려고 할 때 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"StaleObjectStateException"}]},{"type":"text","value":"이 발생하는 것이 원인이었습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"서버 측에서 이를 해결하기 위해 아래의 방법들을 살펴봤습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"Serializable"}]},{"type":"text","value":" 격리 수준 사용"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"비즈니스 로직 변경"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"2번을 선택해서 예외가 발생하는 확률을 훨씬 줄이고 성능은 그대로 유지할 수 있었습니다.\n그러나 근본적인 문제인 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"StaleObjectStateExcpetion"}]},{"type":"text","value":"은 해결되지 않았고, 추가로 낙관적 잠금을 사용하게 됐습니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"위의 방법이 모든 상황에서 정답은 아닙니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"각자가 Trade-Off 사이에서 고민한 선택이 결과적으로도 최고의 선택이었기를 바랍니다.\n지금까지 긴 글 읽어주셔서 정말 감사합니다😃\n다 같이 힘내서 더 성장해 보아요🤍"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"참고"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"백은빈, 이성욱 지음, Real MySQL 8.0"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://docs.oracle.com/javaee/7/tutorial/persistence-intro003.htm#BNBQW"},"children":[{"type":"text","value":"Managing Entities"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.digitalocean.com/community/tutorials/hibernate-caching-first-level-cache"},"children":[{"type":"text","value":"Hibernate Caching"}]}]},{"type":"text","value":"\n"}]}],"data":{"quirksMode":false}},"excerpt":"안녕하세요. 우아한테크코스 5기 BE…","timeToRead":6,"frontmatter":{"title":"무한스크롤 기능에서 동시성 이슈 해결하기","userDate":"11 October 2023","date":"2023-10-11T12:00:00.000Z","tags":["concurrency","transaction","transactional"],"excerpt":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABgADBf/EABYBAQEBAAAAAAAAAAAAAAAAAAMCBf/aAAwDAQACEAMQAAABGuO1uwFoXZ1//8QAGhAAAgMBAQAAAAAAAAAAAAAAAgMBBAUTAP/aAAgBAQABBQIOQ+Asni3MpMlOHYqL09wWCy1En//EAB8RAAIABgMBAAAAAAAAAAAAAAECAAMRMUFhBFGBkf/aAAgBAwEBPwHjyTLAVJjMBkMQuLXr5BAr3v5uP//EAB8RAAIABQUAAAAAAAAAAAAAAAECAAMEEXExQVGBkf/aAAgBAgEBPwGqrRNF3lIrnYqGc50t3AnPwfMR/8QAKRAAAgECBAUDBQAAAAAAAAAAAQIDBBEAEiEiBRMjMUEUMlEkYWKBkf/aAAgBAQAGPwIWgk/dfK39+nxF0pGm9r50aw075o5uob+7YjEa5MBxS8NmDC+c1cQbztdKtI5kYeVZbeVLA3wtVxSSlo4R36PrHJ77YUDxX+OY7L8g4jgoYYkpYVIImpaZvUnTe0XKMcOguvLs2ZjewCqp3ZfxCmw+2P/EABoQAQEBAQEBAQAAAAAAAAAAAAERIQBBMWH/2gAIAQEAAT8hYBuTYn5sszcfT3vQJGWLMaqYBXArTIDoovkicO1nlMOLIkA+iXREZtGDXMAtQuU+yUTV+JXYDIWEwM87/9oADAMBAAIAAwAAABC/L//EABsRAQEBAAIDAAAAAAAAAAAAAAERIQAxQWGB/9oACAEDAQE/EAf0YQEaoXq55m8oNNWhV3SoXrtBfuf/xAAaEQEBAAMBAQAAAAAAAAAAAAABEQAhQTFR/9oACAECAQE/EFHmGgY6RA1wb9SYsIJqEAHEjAL178z/xAAYEAEBAQEBAAAAAAAAAAAAAAABEQAhMf/aAAgBAQABPxCM7MtZFVZ24DhGmcmIpsIM6pTScVo1fRjVH1aGFbwvlaHFtiG6AWl/JtjCcxI6FavnFFReiAEAIAKVv//Z"},"images":{"fallback":{"src":"/static/18871549296c521726f7cc5d7f29c2a1/68d0b/object-optimistic-locking-failure-exception.jpg","srcSet":"/static/18871549296c521726f7cc5d7f29c2a1/6c918/object-optimistic-locking-failure-exception.jpg 750w,\n/static/18871549296c521726f7cc5d7f29c2a1/49438/object-optimistic-locking-failure-exception.jpg 1080w,\n/static/18871549296c521726f7cc5d7f29c2a1/68d0b/object-optimistic-locking-failure-exception.jpg 1280w","sizes":"100vw"},"sources":[{"srcSet":"/static/18871549296c521726f7cc5d7f29c2a1/2b382/object-optimistic-locking-failure-exception.avif 750w,\n/static/18871549296c521726f7cc5d7f29c2a1/5688c/object-optimistic-locking-failure-exception.avif 1080w,\n/static/18871549296c521726f7cc5d7f29c2a1/1c2eb/object-optimistic-locking-failure-exception.avif 1280w","type":"image/avif","sizes":"100vw"},{"srcSet":"/static/18871549296c521726f7cc5d7f29c2a1/66907/object-optimistic-locking-failure-exception.webp 750w,\n/static/18871549296c521726f7cc5d7f29c2a1/27610/object-optimistic-locking-failure-exception.webp 1080w,\n/static/18871549296c521726f7cc5d7f29c2a1/9ba0b/object-optimistic-locking-failure-exception.webp 1280w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.75}}},"author":[{"name":"5기_연어","bio":"우아한테크코스 5기 연어를 좋아하는 연어(황재현)입니다 😃","avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","backgroundColor":"#d8d8c8","images":{"fallback":{"src":"/static/1279d7bd590002b51bc72503da47ebda/99ed2/salmon.jpg","srcSet":"/static/1279d7bd590002b51bc72503da47ebda/f6b2a/salmon.jpg 40w,\n/static/1279d7bd590002b51bc72503da47ebda/1b13e/salmon.jpg 80w,\n/static/1279d7bd590002b51bc72503da47ebda/99ed2/salmon.jpg 120w","sizes":"100vw"},"sources":[{"srcSet":"/static/1279d7bd590002b51bc72503da47ebda/2be77/salmon.webp 40w,\n/static/1279d7bd590002b51bc72503da47ebda/5e049/salmon.webp 80w,\n/static/1279d7bd590002b51bc72503da47ebda/f7a7a/salmon.webp 120w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.9083333333333333}}}}],"source":null}},"relatedPosts":{"totalCount":2,"edges":[{"node":{"id":"f86a6336-fe74-5ddf-b375-b6fcdd2abb6d","timeToRead":6,"excerpt":"안녕하세요. 우아한테크코스 5기 BE…","frontmatter":{"title":"무한스크롤 기능에서 동시성 이슈 해결하기","date":"2023-10-11T12:00:00.000Z"},"fields":{"slug":"/post/2023-08-16-ObjectOptimisticLockingFailureException/"}}},{"node":{"id":"a5f414cd-b97a-5822-8d8b-b3a881cda16e","timeToRead":9,"excerpt":"…","frontmatter":{"title":"선착순 티켓 예매의 동시성 문제: 잠금으로 안전하게 처리하기","date":"2023-09-18T12:00:00.000Z"},"fields":{"slug":"/post/2023-08-16-concurrency-managing/"}}}]}},"pageContext":{"slug":"/post/2023-08-16-ObjectOptimisticLockingFailureException/","prev":{"excerpt":"OSI 7계층과 전송제어 프로토콜 데이터 통신은 여러 단계로 진행되는데, OSI 참조 모델은 그 과정을 7개 계층으로 나눈다.\n1계층(물리 계층)은 ‘케이블이 연결된 상대에 대한 전기·기계적 신호 전달’ 제어를 담당한다.…","timeToRead":4,"frontmatter":{"title":"전송 제어 프로토콜이란?","tags":["Network"],"date":"2023-10-11T12:00:00.000Z","draft":false,"excerpt":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACjElEQVR42qVUy04UQRRtRhEfPKarqrsZeUXFRBkJCkYRhMQXIEEMGkxgoRENCxMWSnC6q6pTP+CGJSsTFWhu9Tg+Ilt/wH/Ce8fxEc0gZGpVXdX31Dn3nCrH2d+oc2oYv4t3dmoC+jW6V7cb2p/DEZq7BWgJTNH/A3yPh1QKWsJ114uSYV+XepmENq7gulBbcyIuDZT/W1yr3xNej4FDiFrnaugVstjvymTcVXbIlzCDBywxbe/5uMelvRgsvzn2X0ARwgCPYJ7pzbOeTvp4lFzLmU9HkeUlFtvLfpie5BKeMbkVc7NxfPcem52MkLCIBV+IiTMLB4ilY0yGR+kZYu9HHwOczzNlxzwDrZU+Ve9ni0z6mUwGRWRHECznqc1TroKrIra3qZeutnkHgZn83CZUOkrAVdiZDIugxw3hCl/5IaVJp6eZTO+TVIFzoe0DYkzOu2pzyFN2ltb4yoemf5nSqco+Esq+4iFMEziTxUEsGhPSLiDjNeonue1HGwFFCI2564XQXd0QlImyHrqq1FH+1uvIKp0UcmsBjVplYXoT5U80vlgXyLDD1Rv5XAE6q1u8+K2epBG7YBlOBNgvLtM7noTztE6MMOCdzLxtzhaSUS9Oh0WYTHYvrTb8neayduqd0O+nPAWPy+6WWdoLIoYBT6bj2UKxjwCp3ySVx/ZGNrYjVe8tXS/8cQJBpsjRrEq7BLpePgxj45ivB4MoOYcKnnBdnMbYNFZqq8emy5SylC8XC4WGpyS33QBDg2YInIBFnGrKK63vHuzKRpd5fZiAkMkS3Rz3pc2j0++whwWSSi1gBnr29Ti0RuDlkA0z280kH+M050dw6+frs+vt2ONJdTU+sgRQM0jt4ztakwusUlOJzwAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/6f324719a8679e503b3cd6a768972ec4/7d307/roy_teaser.png","srcSet":"/static/6f324719a8679e503b3cd6a768972ec4/f054e/roy_teaser.png 750w,\n/static/6f324719a8679e503b3cd6a768972ec4/ae1c8/roy_teaser.png 1080w,\n/static/6f324719a8679e503b3cd6a768972ec4/d41bd/roy_teaser.png 1366w,\n/static/6f324719a8679e503b3cd6a768972ec4/7d307/roy_teaser.png 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/6f324719a8679e503b3cd6a768972ec4/4f03f/roy_teaser.webp 750w,\n/static/6f324719a8679e503b3cd6a768972ec4/4f506/roy_teaser.webp 1080w,\n/static/6f324719a8679e503b3cd6a768972ec4/f0a0a/roy_teaser.webp 1366w,\n/static/6f324719a8679e503b3cd6a768972ec4/26222/roy_teaser.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}},"author":[{"name":"5기_로이","bio":"우아한테크코스 5기 로이(김덕우)입니다 :)","avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAbABQDASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAcECAMGCf/EABYBAQEBAAAAAAAAAAAAAAAAAAUEA//aAAwDAQACEAMQAAABxrjbpZEiALOCwNKOjyEMna0kERl//8QAHhAAAgMAAQUAAAAAAAAAAAAABAUBAwYHAAIREhb/2gAIAQEAAQUCUYg/PDNrm7a74FdTdnvGXRvQnBZBMtc1LRr3jE13Ch9cs8iHxrN8KMuZ5f1b4q1Gqsn/xAAkEQACAgEDBAIDAAAAAAAAAAABAgMREgQFIgAUITETcTJRYf/aAAgBAwEBPwHSdzqhqNHFJEfjSSZFLMvNFVyqEDFnOJaj+XJVORHTR7krFWtWBohQmIPi6uzX35/fT7zpNujlTsmk1Mk+njilEmCRxuSGscsmJwuwbHrCuTbmzMSUKkn0GDAfyygJ+6HX/8QAIxEAAgIBAwMFAAAAAAAAAAAAAQIDEQQSEyEABRQiJDFScf/aAAgBAgEBPwGfMx33HhQrMEIV2QaGY8RtKARIImZwpYU4XmjVdYje2x/KRmydmMZDwhtp5gqiR47lY6HYFlBZiAQCzHkwdokynjK5AiTakaS0EkkjAAj1GqUC6Abg/YE0nbo0VUDatIA1EFSfjkgMQPyz1//EACUQAAICAgICAgIDAQAAAAAAAAIDAQQFEhETACEUIwYiBzEzYf/aAAgBAQAGPwK7Ne1bVeJsEt5vZW6xUk1LCaRjqozglmTPsYvoGFRMEfisTKb78lVYVVV/maLZxbRIzD5cs+pe+z68yzsRPdES6GxpcS6hWaSrbgFvyLNuGq9EpkWNRlmwFE7EIzzzzEeA29/IWRy9s+KiMY60eRxXy9onWr8mq3riYhgwRWpmOr3AdwCGA/IbD7CU2LgjQUiy6vRbEKlPxmJqqli632ttMYIPkndmpzp1eJxZErLsBAObdx6Mm+sTHSREIsmsgp19a7LgoVK9v258x/4vhpU3L5HJVqiWmRjjatl7RrLeavYTqRbRByev7TIzzx4unkM3jb9XHjSpuchTis16teipS2Go2AgPm2BdYmwsmDK/YoCGCfkx+P8AZjsfGMoxChp1bENZENibG5BPEtDr2GJmN4k/7KfMBj6KV1qiPx/J3lLWMcjcOx+1rtnlxP8AqCRaTJMJ2kJiTOSzNnJqRdsRLPudXQTfqUHXyfXBTpsUDzM8DOsfr68EjqRM6DH+r/Ue/URDeIj/AJHrz//EABgQAQEBAQEAAAAAAAAAAAAAAAERACEx/9oACAEBAAE/IQFQiaJ0UdlED0lQoTgUSQkfsCS2fl8+usWVntijvtJAdsDXBY4uj8ixfCyztpWT08vXDnqfemKYc41OZKUN9Oj52q77I1xVmARd9tZdqsZWtUOuYpyeOLLrwlCjdsughioU4AUAAVgA8AN//9oADAMBAAIAAwAAABB/J37/xAAYEQEBAQEBAAAAAAAAAAAAAAABEQAhMf/aAAgBAwEBPxCgK9+BcArCCa/JBRMBgNxKSkBEpgR4vnJ/jSFVaJrjQLNHIJAPSNWHJ//EABgRAQEBAQEAAAAAAAAAAAAAAAERACEx/9oACAECAQE/EHAAVC20SFJmlVltRZEcldOQdXl9xCFBiMQ9zFRgeBj6TlRYA4Vl3//EABgQAQEBAQEAAAAAAAAAAAAAAAEAERAh/9oACAEBAAE/ENWUJsXDHbhDwdxL7b2vP9Rt44L5NCeIaKgJYiTTcrIkU0sRFicyrBR6WfYhEh9anIB4DUCo5hfslHukN0g4ZtvsbSzVAfRRQMezog0piWmg1gkCcFhQAE9AVJqcyGGK7C8Ec/l9fEF//9k="},"images":{"fallback":{"src":"/static/1be0cd5036158133d1f178beaee9664e/70fde/roy_avatar.jpg","srcSet":"/static/1be0cd5036158133d1f178beaee9664e/b0c6e/roy_avatar.jpg 750w,\n/static/1be0cd5036158133d1f178beaee9664e/b3149/roy_avatar.jpg 1080w,\n/static/1be0cd5036158133d1f178beaee9664e/c56d6/roy_avatar.jpg 1366w,\n/static/1be0cd5036158133d1f178beaee9664e/70fde/roy_avatar.jpg 1920w","sizes":"100vw"},"sources":[{"srcSet":"/static/1be0cd5036158133d1f178beaee9664e/4c1cf/roy_avatar.webp 750w,\n/static/1be0cd5036158133d1f178beaee9664e/2eb44/roy_avatar.webp 1080w,\n/static/1be0cd5036158133d1f178beaee9664e/120d8/roy_avatar.webp 1366w,\n/static/1be0cd5036158133d1f178beaee9664e/31d0c/roy_avatar.webp 1920w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1.3333333333333333}}}}]},"fields":{"layout":"post","slug":"/post/2023-08-10-WHAT-IS-TCP/"}},"next":{"excerpt":"들어가면서 JPA를 사용한 개발을 진행하면서 가장 많이 들었던 고민 중 하나는  였습니다. ‘Cascade…","timeToRead":5,"frontmatter":{"title":"JPA Cascade는 무엇이고 언제 사용해야 할까?","tags":["JPA","Cascade"],"date":"2023-10-16T12:00:00.000Z","draft":false,"excerpt":null,"image":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAUGBwj/xAAWAQEBAQAAAAAAAAAAAAAAAAACBAb/2gAMAwEAAhADEAAAAeraiMQ6GPRxoBf/xAAbEAACAgMBAAAAAAAAAAAAAAAEBQMGAAECIf/aAAgBAQABBQIOUkHYT4FgNvtfNinnyzBwjC1hHFYlv//EABYRAQEBAAAAAAAAAAAAAAAAAAASYf/aAAgBAwEBPwFWP//EABoRAAICAwAAAAAAAAAAAAAAAAECAGESIYH/2gAIAQIBAT8BYTJBouQe1U//xAAmEAACAgIBAwIHAAAAAAAAAAACAwEEERMSAAUhI0EUIjJCQ1GB/9oACAEBAAY/AqLKLLvdKZi5DE7q2VYgjqLASSJinYXF9ybGYXxlysRzh9w2qowmPV+It05XAEMGtm5L2qlUwYSs4LBcsBJ9bEuqXAL80Fs8/cOV5j5Z8Y8THvHU4n6VyQ+/Gffj+sx/eqdumC6oP7jWi1VWM6bOT9PnEnxgENGXqXAcBcW0YFgifW9zirzQsM7YOuCI3qSK3qdZPYO2zwswljZjLISJl5mev//EABkQAQEBAQEBAAAAAAAAAAAAAAERIQAxQf/aAAgBAQABPyHXIhSAWt0ljdUSzEcCKk6CZTFlALD6tTFtWKQzohohRqz3GSUY+MzkIl56xzAZPEStjK4JFwHXOmP/2gAMAwEAAgADAAAAEOfv/8QAHREAAQMFAQAAAAAAAAAAAAAAAQARITFBUYHw4f/aAAgBAwEBPxAVDZHc2kIB5Xnxf//EABsRAAMAAgMAAAAAAAAAAAAAAAERITFBUWHx/9oACAECAQE/EGWWODbRKJLqnD7ZQBoRqlkEMDXv/8QAFxABAQEBAAAAAAAAAAAAAAAAAREAIf/aAAgBAQABPxBf0wcNG7A5yMuNtjJj0Bi+rvRKJA+zmosRXTThCwUR27M6s8dzD2oXZZ3kFB2DhLeHbiVhqf/Z"},"images":{"fallback":{"src":"/static/0ce329789b1b1aadc28d74df1b772990/ea78d/chain.jpg","srcSet":"/static/0ce329789b1b1aadc28d74df1b772990/1a909/chain.jpg 750w,\n/static/0ce329789b1b1aadc28d74df1b772990/997dc/chain.jpg 1080w,\n/static/0ce329789b1b1aadc28d74df1b772990/ea78d/chain.jpg 1280w","sizes":"100vw"},"sources":[{"srcSet":"/static/0ce329789b1b1aadc28d74df1b772990/207cf/chain.webp 750w,\n/static/0ce329789b1b1aadc28d74df1b772990/3c432/chain.webp 1080w,\n/static/0ce329789b1b1aadc28d74df1b772990/f5c3c/chain.webp 1280w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":0.6640625}}},"author":[{"name":"5기_테오","bio":"우아한테크코스 5기 테오(최우성)입니다:)","avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"fullWidth","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAkIBgf/xAAYAQEAAwEAAAAAAAAAAAAAAAADAAECBP/aAAwDAQACEAMQAAAB1/NajfcBJ+Mguk7i+bCZhuGv/8QAHBAAAgIDAQEAAAAAAAAAAAAABAUCBgEDBwAI/9oACAEBAAEFAoWXDmr3zmtnm4B+eXJAkKciALXlgLc9aYbkd8JI3jejWlcNHVd8ttp//8QAIhEAAgECBQUAAAAAAAAAAAAAARECACEDEBIxURNigZHS/9oACAEDAQE/ARKAiXDVJcpcFo7G5tcWYbrq9mH6P1Q285f/xAAlEQABAgQEBwAAAAAAAAAAAAABAhEAAxIxBCFBUQUTInGS0vD/2gAIAQIBAT8B5K5k1NRAk1OQRUDbIpyBfR3APUUlmgcJwrXX5J9YYVDIa6fbCCS9zfftH//EACQQAAICAgICAgIDAAAAAAAAAAIDAQQREgUTACEUIiQxFSNC/9oACAEBAAY/Aqzk/HK1ZUvVRW1hMzE9Zs1xLdAz9iEC94j9z4zl+G4QOeLl+Qu2/wAG1CWo+S6GELYe5AdcTI7WZYIrxmRCPXld15tlVliVmxNMq/IJRLBhnR8sriIaaduo5XBq2GdGnHg3bHA0/wCTbUCkrlIEu/4SymVorN2x17zsU/075HfbEYVxwdBTyBt1BulkmwhOzFwTN5YKwBhkEeg+0l685upwjC4/j2FXuBVr/j11ss11m7oUsoEQJu0+hH7bYjGPFIBpytrEwUMnsn7QP6Islgf8LmZUH7heffiWrBy3cfcs2abosMlldz3uY0l9knEbxZaooxiUT0zGmYn5ZQPdd42nZfiJ1luXJyMTM6RokI1HAxj1Hn//xAAaEAEBAAMBAQAAAAAAAAAAAAABEQAhMVFB/9oACAEBAAE/Ia1W0qLaHLLpdOOMYvtgmzu1FIao09iuL+rNQYFOi3MxWldAWLqhNCC3Xxr3bYvaVarR/IgqGzePfO0j415KV4WbWrSPizv0ZEma7Y5j432AK5//2gAMAwEAAgADAAAAEK/A/f/EAB8RAQEAAQMFAQAAAAAAAAAAAAERIQBBUTFhcZHB0f/aAAgBAwEBPxAUG0FFJKIEQKJONFjpYc3jHl33duXSay5A5chAHmCnh0BDGx8/D1r/xAAcEQEBAAICAwAAAAAAAAAAAAABEQAhMWFBUZH/2gAIAQIBAT8QAKhXBYvYTNxCIbQztUICtQoYNDRqaJMHu0Io1RWa1VGcwvBg0BHhXvv2/XP/xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhMWH/2gAIAQEAAT8QCg98/ECXFLx7rvo+Gj0gJTuyM2/ZqC+voB10VN5XxsqhEthrPbwIv2wMGpjgz3+BkSjN00iEUMMFx9yYqhGnbiJKVGg1uOvy5XFRa9VK/wD/2Q=="},"images":{"fallback":{"src":"/static/0b24b9a0bd7bed90d2fb2e62f525e49c/37851/teo.jpg","srcSet":"/static/0b24b9a0bd7bed90d2fb2e62f525e49c/37851/teo.jpg 460w","sizes":"100vw"},"sources":[{"srcSet":"/static/0b24b9a0bd7bed90d2fb2e62f525e49c/b5c5b/teo.webp 460w","type":"image/webp","sizes":"100vw"}]},"width":1,"height":1}}}}]},"fields":{"layout":"post","slug":"/post/2023-08-14-JPA-Cascade/"}},"primaryTag":"concurrency"}},"staticQueryHashes":["2337738035"],"slicesMap":{}}